<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PIP图像标注工具 - CYBER EDITION</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --neon-green: #39ff14;
            --dark-bg: #0d0d0d;
            --card-bg: #1a1a1a;
            --border-color: #2a2a2a;
            --text-primary: #ffffff;
            --text-secondary: #b0b0b0;
            --accent-green: #39ff14;
            --hover-bg: #252525;
        }

        * {
            box-sizing: border-box;
        }

        body {
            background: var(--dark-bg);
            min-height: 100vh;
            font-family: 'Rajdhani', sans-serif;
            color: var(--text-primary);
            overflow-x: hidden;
        }

        .main-container {
            background: var(--card-bg);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            margin: 20px auto;
            max-width: 1200px;
            position: relative;
            z-index: 2;
        }

        .glitch-title {
            font-family: 'Orbitron', monospace;
            font-weight: 700;
            font-size: 2.5rem;
            color: var(--text-primary);
            position: relative;
        }

        .nav-pills .nav-link {
            background: var(--border-color);
            border: 2px solid var(--border-color);
            color: var(--text-secondary);
            margin: 0 8px;
            border-radius: 15px;
            transition: all 0.3s ease;
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            padding: 12px 24px;
        }

        .nav-pills .nav-link:hover {
            background: var(--hover-bg);
            color: var(--text-primary);
            border-color: var(--neon-green);
        }

        .nav-pills .nav-link.active {
            background: var(--neon-green);
            color: var(--dark-bg);
            border-color: var(--neon-green);
            box-shadow: 0 0 20px rgba(57, 255, 20, 0.3);
        }

        .card {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            border-color: var(--neon-green);
        }

        .btn-primary {
            background: var(--neon-green);
            border: 2px solid var(--neon-green);
            color: var(--dark-bg);
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            border-radius: 15px;
            padding: 12px 30px;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px rgba(57, 255, 20, 0.3);
            background: var(--neon-green);
            border-color: var(--neon-green);
        }

        .btn-outline-primary {
            background: transparent;
            border: 2px solid var(--neon-green);
            color: var(--neon-green);
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            border-radius: 15px;
        }

        .btn-outline-primary:hover {
            background: var(--neon-green);
            color: var(--dark-bg);
            box-shadow: 0 0 20px rgba(57, 255, 20, 0.3);
        }

        .btn-outline-secondary {
            background: transparent;
            border: 2px solid var(--text-secondary);
            color: var(--text-secondary);
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            border-radius: 15px;
        }

        .btn-outline-secondary:hover {
            background: var(--text-secondary);
            color: var(--dark-bg);
            box-shadow: 0 0 20px rgba(176, 176, 176, 0.3);
        }

        .form-control, .form-select {
            background: var(--border-color);
            border: 2px solid var(--border-color);
            color: var(--text-primary);
            font-family: 'Rajdhani', sans-serif;
            font-weight: 500;
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            background: var(--hover-bg);
            border-color: var(--neon-green);
            box-shadow: 0 0 0 0.2rem rgba(57, 255, 20, 0.25);
            color: var(--text-primary);
        }

        .form-control::placeholder {
            color: var(--text-secondary);
        }

        .progress {
            height: 25px;
            background: var(--border-color);
            border-radius: 15px;
            overflow: hidden;
        }

        .progress-bar {
            background: var(--neon-green);
            border-radius: 15px;
            transition: width 0.3s ease;
        }

        .status-box {
            background: var(--border-color);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 20px;
            margin-top: 20px;
            max-height: 300px;
            overflow-y: auto;
        }

        .feature-icon {
            font-size: 3rem;
            color: var(--neon-green);
        }

        .section-title {
            color: var(--text-primary);
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            margin-bottom: 30px;
            text-align: center;
        }

        .option-group {
            background: var(--border-color);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .checkbox-group {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            background: var(--hover-bg);
        }

        .file-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .file-item {
            background: var(--border-color);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .file-item:hover {
            background: var(--hover-bg);
            border-color: var(--neon-green);
        }

        .form-label {
            color: var(--neon-green);
            font-family: 'Rajdhani', sans-serif;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .form-check-label {
            color: var(--text-primary);
            font-family: 'Rajdhani', sans-serif;
            font-weight: 500;
        }

        .form-check-input:checked {
            background-color: var(--neon-green);
            border-color: var(--neon-green);
        }

        .text-muted {
            color: var(--text-secondary) !important;
        }

        .text-success {
            color: var(--neon-green) !important;
        }

        .text-danger {
            color: #ff4444 !important;
        }

        .lead {
            color: var(--text-secondary);
            font-family: 'Rajdhani', sans-serif;
            font-weight: 400;
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--border-color);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--neon-green);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }
    </style>
</head>
<body>
    <div class="container-fluid p-4">
        <div class="main-container p-4">
            <div class="text-center mb-4">
                <h1 class="glitch-title">
                    <i class="fas fa-robot me-3"></i>PIP图像标注工具
                </h1>
                <p class="lead text-muted">集成图像处理、AI标注和标签管理的一站式解决方案</p>
            </div>

            <!-- 导航标签 -->
            <ul class="nav nav-pills nav-justified mb-4" id="mainTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="preprocess-tab" data-bs-toggle="pill" data-bs-target="#preprocess" type="button" role="tab">
                        <i class="fas fa-image me-2"></i>图像预处理
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="single-annotation-tab" data-bs-toggle="pill" data-bs-target="#single-annotation" type="button" role="tab">
                        <i class="fas fa-file-image me-2"></i>单张标注
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="annotation-tab" data-bs-toggle="pill" data-bs-target="#annotation" type="button" role="tab">
                        <i class="fas fa-tags me-2"></i>批量标注
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="custom-templates-tab" data-bs-toggle="pill" data-bs-target="#custom-templates" type="button" role="tab">
                        <i class="fas fa-edit me-2"></i>自定义模板
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="management-tab" data-bs-toggle="pill" data-bs-target="#management" type="button" role="tab">
                        <i class="fas fa-cogs me-2"></i>标签管理
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="mainTabContent">
                <!-- 单张图像标注 -->
                <div class="tab-pane fade" id="single-annotation" role="tabpanel">
                    <div class="card">
                        <div class="card-body">
                            <div class="text-center mb-4">
                                <i class="fas fa-file-image feature-icon"></i>
                                <h3 class="section-title">单张图像标注</h3>
                                <p class="text-muted">上传单张图片进行AI智能标注分析</p>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="option-group">
                                        <label class="form-label">
                                            <i class="fas fa-upload me-2"></i>选择图片文件
                                        </label>
                                        <input type="file" class="form-control" id="singleImageFile" accept="image/*" onchange="previewSingleImage()">
                                    </div>

                                    <div class="option-group">
                                        <label class="form-label">
                                            <i class="fas fa-brain me-2"></i>标注模式
                                        </label>
                                        <select class="form-select" id="singleAnnotationType" onchange="toggleSingleAnalysisTypes()">
                                            <option value="natural">自然语言推理</option>
                                            <option value="tags">标签推理</option>
                                            <option value="mixed">混合标签</option>
                                        </select>
                                    </div>

                                    <div class="option-group">
                                        <label class="form-label">
                                            <i class="fas fa-language me-2"></i>输出语言
                                        </label>
                                        <select class="form-select" id="singleLanguage">
                                            <option value="en" selected>English（默认）</option>
                                            <option value="zh">中文</option>
                                        </select>
                                    </div>


                                    <button class="btn btn-primary btn-lg w-100" onclick="startSingleAnnotation()" id="singleAnnotateBtn" disabled>
                                        <i class="fas fa-magic me-2"></i>开始标注
                                    </button>
                                </div>

                                <div class="col-md-6">
                                    <div class="option-group">
                                        <h5><i class="fas fa-eye me-2"></i>图片预览</h5>
                                        <div id="imagePreviewContainer" class="text-center" style="min-height: 200px; border: 2px dashed var(--border-color); border-radius: 12px; display: flex; align-items: center; justify-content: center;">
                                            <p class="text-muted">
                                                <i class="fas fa-image me-2"></i>请选择图片文件
                                            </p>
                                        </div>
                                        <div id="imageInfo" class="mt-2 text-muted small" style="display: none;">
                                            <div><strong>文件名:</strong> <span id="fileName"></span></div>
                                            <div><strong>尺寸:</strong> <span id="imageDimensions"></span></div>
                                            <div><strong>大小:</strong> <span id="fileSize"></span></div>
                                        </div>
                                    </div>

                                    <div class="option-group" id="singleResultContainer" style="display: none;">
                                        <h5><i class="fas fa-clipboard-list me-2"></i>标注结果</h5>
                                        <div id="singleAnnotationResult" class="status-box" style="max-height: 250px;">
                                        </div>
                                        <div id="processingTime" class="mt-2 text-muted small" style="display: none;">
                                            <i class="fas fa-clock me-2"></i>处理耗时: <span id="timeElapsed"></span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 图像预处理 -->
                <div class="tab-pane fade show active" id="preprocess" role="tabpanel">
                    <div class="card">
                        <div class="card-body">
                            <div class="text-center mb-4">
                                <i class="fas fa-image feature-icon"></i>
                                <h3 class="section-title">图像预处理</h3>
                                <p class="text-muted">调整图像尺寸、格式转换和文件重命名</p>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="option-group">
                                        <label class="form-label fw-bold">
                                            <i class="fas fa-folder me-2"></i>图片文件夹路径
                                        </label>
                                        <input type="text" class="form-control" id="convertFolderPath" placeholder="请输入图片文件夹路径">
                                    </div>

                                    <div class="option-group">
                                        <label class="form-label fw-bold">
                                            <i class="fas fa-expand-arrows-alt me-2"></i>最大尺寸 (像素)
                                        </label>
                                        <input type="number" class="form-control" id="maxSize" value="768" min="100" max="4096">
                                    </div>

                                    <div class="option-group">
                                        <label class="form-label fw-bold">
                                            <i class="fas fa-file-image me-2"></i>输出格式
                                        </label>
                                        <select class="form-select" id="outputFormat">
                                            <option value="PNG">PNG</option>
                                            <option value="JPEG">JPEG</option>
                                            <option value="WEBP">WEBP</option>
                                        </select>
                                    </div>

                                    <div class="option-group">
                                        <div class="form-check">
                                            <input class="form-check-input" type="checkbox" id="renameFiles">
                                            <label class="form-check-label fw-bold" for="renameFiles">
                                                <i class="fas fa-signature me-2"></i>重命名文件 (使用UUID)
                                            </label>
                                        </div>
                                    </div>

                                    <button class="btn btn-primary btn-lg w-100" onclick="startImageConversion()">
                                        <i class="fas fa-play me-2"></i>开始转换
                                    </button>
                                </div>

                                <div class="col-md-6">
                                    <div id="convertProgress" class="d-none">
                                        <h5><i class="fas fa-spinner fa-spin me-2"></i>处理进度</h5>
                                        <div class="progress mb-3">
                                            <div class="progress-bar progress-bar-striped progress-bar-animated" id="convertProgressBar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <div class="status-box" id="convertStatus">
                                        <p class="text-muted text-center">
                                            <i class="fas fa-info-circle me-2"></i>请配置参数后开始转换
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 批量AI标注 -->
                <div class="tab-pane fade" id="annotation" role="tabpanel">
                    <div class="card">
                        <div class="card-body">
                            <div class="text-center mb-4">
                                <i class="fas fa-robot feature-icon"></i>
                                <h3 class="section-title">批量AI标注</h3>
                                <p class="text-muted">使用GPT-4o模型进行批量智能图像分析和标注</p>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="option-group">
                                        <label class="form-label fw-bold">
                                            <i class="fas fa-folder me-2"></i>图片文件夹路径
                                        </label>
                                        <input type="text" class="form-control" id="annotationFolderPath" placeholder="请输入图片文件夹路径">
                                    </div>

                                    <div class="option-group">
                                        <label class="form-label fw-bold">
                                            <i class="fas fa-brain me-2"></i>标注模式
                                        </label>
                                        <select class="form-select" id="annotationType" onchange="toggleAnalysisTypes()">
                                            <option value="natural">自然语言推理</option>
                                            <option value="tags">标签推理</option>
                                            <option value="mixed">混合标签</option>
                                        </select>
                                    </div>

                                    <div class="option-group">
                                        <label class="form-label fw-bold">
                                            <i class="fas fa-language me-2"></i>输出语言
                                        </label>
                                        <select class="form-select" id="annotationLanguage">
                                            <option value="en" selected>English（默认）</option>
                                            <option value="zh">中文</option>
                                        </select>
                                    </div>


                                    <button class="btn btn-primary btn-lg w-100" onclick="startAnnotation()">
                                        <i class="fas fa-magic me-2"></i>开始标注
                                    </button>
                                </div>

                                <div class="col-md-6">
                                    <div id="annotationProgress" class="d-none">
                                        <h5><i class="fas fa-spinner fa-spin me-2"></i>标注进度</h5>
                                        <div class="progress mb-3">
                                            <div class="progress-bar progress-bar-striped progress-bar-animated" id="annotationProgressBar" style="width: 0%"></div>
                                        </div>
                                    </div>
                                    <div class="status-box" id="annotationStatus">
                                        <p class="text-muted text-center">
                                            <i class="fas fa-info-circle me-2"></i>请配置参数后开始标注
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 自定义模板 -->
                <div class="tab-pane fade" id="custom-templates" role="tabpanel">
                    <div class="card">
                        <div class="card-body">
                            <div class="text-center mb-4">
                                <i class="fas fa-edit feature-icon"></i>
                                <h3 class="section-title">自定义模板管理</h3>
                                <p class="text-muted">创建和管理您的专属提示词模板</p>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="option-group">
                                        <h5><i class="fas fa-plus me-2"></i>创建新模板</h5>
                                        <div class="mb-3">
                                            <label class="form-label">模板名称</label>
                                            <input type="text" class="form-control" id="templateName" placeholder="输入模板名称">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">模板描述</label>
                                            <input type="text" class="form-control" id="templateDescription" placeholder="输入模板描述（可选）">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">提示词内容</label>
                                            <textarea class="form-control" id="templatePrompt" rows="8" placeholder="输入您的提示词内容..."></textarea>
                                        </div>
                                        <button class="btn btn-primary w-100 mb-3" onclick="saveTemplate()">
                                            <i class="fas fa-save me-2"></i>保存模板
                                        </button>
                                        <button class="btn btn-outline-secondary w-100" onclick="clearTemplateForm()">
                                            <i class="fas fa-eraser me-2"></i>清空表单
                                        </button>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="option-group">
                                        <h5><i class="fas fa-list me-2"></i>已有模板</h5>
                                        <div class="file-list" id="templateList">
                                            <p class="text-muted text-center">
                                                <i class="fas fa-info-circle me-2"></i>正在加载模板列表...
                                            </p>
                                        </div>
                                    </div>
                                    <div class="status-box" id="templateStatus">
                                        <p class="text-muted text-center">
                                            <i class="fas fa-info-circle me-2"></i>等待操作
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 标签管理 -->
                <div class="tab-pane fade" id="management" role="tabpanel">
                    <div class="card">
                        <div class="card-body">
                            <div class="text-center mb-4">
                                <i class="fas fa-cogs feature-icon"></i>
                                <h3 class="section-title">标签管理</h3>
                                <p class="text-muted">批量管理和编辑标注文件</p>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="option-group">
                                        <label class="form-label fw-bold">
                                            <i class="fas fa-folder me-2"></i>文件夹路径
                                        </label>
                                        <input type="text" class="form-control" id="managementFolderPath" placeholder="请输入文件夹路径">
                                        <button class="btn btn-outline-primary mt-2" onclick="listFiles()">
                                            <i class="fas fa-refresh me-2"></i>刷新文件列表
                                        </button>
                                    </div>

                                    <div class="option-group">
                                        <h5><i class="fas fa-edit me-2"></i>批量编辑</h5>
                                        <div class="mb-3">
                                            <label class="form-label">搜索文本</label>
                                            <input type="text" class="form-control" id="searchText" placeholder="要搜索的文本">
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">替换文本</label>
                                            <input type="text" class="form-control" id="replaceText" placeholder="替换为（留空则删除）">
                                        </div>
                                        <div class="form-check mb-3">
                                            <input class="form-check-input" type="checkbox" id="addTrigger">
                                            <label class="form-check-label" for="addTrigger">添加触发词</label>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label">触发词</label>
                                            <input type="text" class="form-control" id="triggerWord" placeholder="触发词">
                                        </div>
                                        <button class="btn btn-primary w-100 mb-3" onclick="processFiles()">
                                            <i class="fas fa-magic me-2"></i>批量处理
                                        </button>
                                        <button class="btn btn-outline-secondary w-100" onclick="convertEncoding()">
                                            <i class="fas fa-code me-2"></i>转换UTF-8编码
                                        </button>
                                    </div>
                                </div>

                                <div class="col-md-6">
                                    <div class="option-group">
                                        <h5><i class="fas fa-file-alt me-2"></i>文件列表</h5>
                                        <div class="file-list" id="fileList">
                                            <p class="text-muted text-center">
                                                <i class="fas fa-info-circle me-2"></i>请先选择文件夹并刷新列表
                                            </p>
                                        </div>
                                    </div>
                                    <div class="status-box" id="managementStatus">
                                        <p class="text-muted text-center">
                                            <i class="fas fa-info-circle me-2"></i>等待操作
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 全局变量
        let currentTaskId = null;

        // 页面加载时初始化
        document.addEventListener('DOMContentLoaded', function() {
            loadAnalysisTypes();
            loadSingleAnalysisTypes();
            loadCustomTemplates();
            loadCustomTemplatesIntoSelects();
        });

        // 加载分析类型
        async function loadAnalysisTypes() {
            try {
                const response = await fetch('/api/get_analysis_types');
                const data = await response.json();
                
                const container = document.getElementById('analysisTypes');
                container.innerHTML = '';
                
                if (data.analysis_types && data.analysis_types.length > 0) {
                    data.analysis_types.forEach(type => {
                        const div = document.createElement('div');
                        div.className = 'form-check mb-2';
                        div.innerHTML = `
                            <input class="form-check-input" type="checkbox" value="${type}" id="type_${type}" checked>
                            <label class="form-check-label" for="type_${type}">${type}</label>
                        `;
                        container.appendChild(div);
                    });
                } else {
                    container.innerHTML = '<p class="text-muted">无法加载分析类型，请检查询问句式.json文件</p>';
                }
            } catch (error) {
                console.error('加载分析类型失败:', error);
                document.getElementById('analysisTypes').innerHTML = '<p class="text-danger">加载分析类型失败</p>';
            }
        }

        // 加载单张图片分析类型
        async function loadSingleAnalysisTypes() {
            try {
                const response = await fetch('/api/get_analysis_types');
                const data = await response.json();
                
                const container = document.getElementById('singleAnalysisTypes');
                container.innerHTML = '';
                
                if (data.analysis_types && data.analysis_types.length > 0) {
                    data.analysis_types.forEach(type => {
                        const div = document.createElement('div');
                        div.className = 'form-check mb-2';
                        div.innerHTML = `
                            <input class="form-check-input" type="checkbox" value="${type}" id="single_type_${type}" checked>
                            <label class="form-check-label" for="single_type_${type}">${type}</label>
                        `;
                        container.appendChild(div);
                    });
                } else {
                    container.innerHTML = '<p class="text-muted">无法加载分析类型，请检查询问句式.json文件</p>';
                }
            } catch (error) {
                console.error('加载分析类型失败:', error);
                document.getElementById('singleAnalysisTypes').innerHTML = '<p class="text-danger">加载分析类型失败</p>';
            }
        }

        // 切换分析类型显示 (功能已移除)
        function toggleSingleAnalysisTypes() {
            // Analysis types feature removed - no action needed
        }

        function toggleAnalysisTypes() {
            // Analysis types feature removed - no action needed
        }

        // 预览单张图片
        function previewSingleImage() {
            const fileInput = document.getElementById('singleImageFile');
            const file = fileInput.files[0];
            const previewContainer = document.getElementById('imagePreviewContainer');
            const imageInfo = document.getElementById('imageInfo');
            const annotateBtn = document.getElementById('singleAnnotateBtn');
            
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const img = new Image();
                    img.onload = function() {
                        // 显示图片预览
                        previewContainer.innerHTML = `<img src="${e.target.result}" style="max-width: 100%; max-height: 300px; border-radius: 8px;" alt="预览图片">`;
                        
                        // 显示图片信息
                        document.getElementById('fileName').textContent = file.name;
                        document.getElementById('imageDimensions').textContent = `${img.width} × ${img.height}px`;
                        document.getElementById('fileSize').textContent = formatFileSize(file.size);
                        imageInfo.style.display = 'block';
                        
                        // 启用标注按钮
                        annotateBtn.disabled = false;
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            } else {
                previewContainer.innerHTML = '<p class="text-muted"><i class="fas fa-image me-2"></i>请选择图片文件</p>';
                imageInfo.style.display = 'none';
                annotateBtn.disabled = true;
            }
        }

        // 格式化文件大小
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // 开始单张图片标注
        async function startSingleAnnotation() {
            const fileInput = document.getElementById('singleImageFile');
            const file = fileInput.files[0];
            const annotationType = document.getElementById('singleAnnotationType').value;
            const language = document.getElementById('singleLanguage').value;
            const resultContainer = document.getElementById('singleResultContainer');
            const resultDiv = document.getElementById('singleAnnotationResult');
            const timeDiv = document.getElementById('processingTime');
            const timeSpan = document.getElementById('timeElapsed');
            
            if (!file) {
                alert('请先选择图片文件');
                return;
            }
            
            let selectedTypes = [];
            
            const formData = new FormData();
            formData.append('image', file);
            formData.append('annotation_type', annotationType);
            formData.append('selected_types', JSON.stringify(selectedTypes));
            formData.append('language', language);
            
            const startTime = Date.now();
            
            try {
                resultContainer.style.display = 'block';
                resultDiv.innerHTML = '<p><i class="fas fa-spinner fa-spin me-2"></i>正在处理图片，请稍候...</p>';
                timeDiv.style.display = 'none';
                
                const response = await fetch('/api/process_single_image', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                const endTime = Date.now();
                const elapsedTime = ((endTime - startTime) / 1000).toFixed(2);
                
                if (result.success) {
                    resultDiv.innerHTML = `<div class="text-success"><i class="fas fa-check-circle me-2"></i><strong>标注完成</strong></div><hr><div style="white-space: pre-wrap;">${result.annotation}</div>`;
                } else {
                    resultDiv.innerHTML = `<div class="text-danger"><i class="fas fa-exclamation-circle me-2"></i><strong>处理失败</strong></div><hr><div>${result.error}</div>`;
                }
                
                timeSpan.textContent = `${elapsedTime}秒`;
                timeDiv.style.display = 'block';
                
            } catch (error) {
                console.error('单张图片标注失败:', error);
                resultDiv.innerHTML = `<div class="text-danger"><i class="fas fa-exclamation-circle me-2"></i><strong>网络错误</strong></div><hr><div>请检查网络连接或服务器状态</div>`;
                
                const endTime = Date.now();
                const elapsedTime = ((endTime - startTime) / 1000).toFixed(2);
                timeSpan.textContent = `${elapsedTime}秒`;
                timeDiv.style.display = 'block';
            }
        }

        // 开始图像转换
        async function startImageConversion() {
            const folderPath = document.getElementById('convertFolderPath').value;
            const maxSize = parseInt(document.getElementById('maxSize').value);
            const outputFormat = document.getElementById('outputFormat').value;
            const renameFiles = document.getElementById('renameFiles').checked;

            if (!folderPath) {
                alert('请输入文件夹路径');
                return;
            }

            const data = {
                folder_path: folderPath,
                max_size: maxSize,
                output_format: outputFormat,
                rename_files: renameFiles
            };

            try {
                const response = await fetch('/api/convert_images', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                currentTaskId = result.task_id;

                document.getElementById('convertProgress').classList.remove('d-none');
                document.getElementById('convertStatus').innerHTML = '<p><i class="fas fa-spinner fa-spin me-2"></i>开始处理...</p>';

                // 开始轮询状态
                pollStatus(currentTaskId, 'convert');

            } catch (error) {
                console.error('启动转换失败:', error);
                document.getElementById('convertStatus').innerHTML = '<p class="text-danger">启动转换失败</p>';
            }
        }

        // 开始标注
        async function startAnnotation() {
            const folderPath = document.getElementById('annotationFolderPath').value;
            const annotationType = document.getElementById('annotationType').value;
            const language = document.getElementById('annotationLanguage').value;
            
            let selectedTypes = [];

            if (!folderPath) {
                alert('请输入文件夹路径');
                return;
            }

            const data = {
                folder_path: folderPath,
                annotation_type: annotationType,
                selected_types: selectedTypes,
                language: language
            };

            try {
                const response = await fetch('/api/process_images', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                currentTaskId = result.task_id;

                document.getElementById('annotationProgress').classList.remove('d-none');
                document.getElementById('annotationStatus').innerHTML = '<p><i class="fas fa-spinner fa-spin me-2"></i>开始标注...</p>';

                // 开始轮询状态
                pollStatus(currentTaskId, 'annotation');

            } catch (error) {
                console.error('启动标注失败:', error);
                document.getElementById('annotationStatus').innerHTML = '<p class="text-danger">启动标注失败</p>';
            }
        }

        // 轮询任务状态
        async function pollStatus(taskId, type) {
            const interval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/process_status/${taskId}`);
                    const status = await response.json();

                    const progressBar = document.getElementById(`${type}ProgressBar`);
                    const statusDiv = document.getElementById(`${type}Status`);

                    if (status.status === 'processing') {
                        progressBar.style.width = `${status.progress}%`;
                        progressBar.textContent = `${status.progress}%`;
                        
                        if (status.messages && status.messages.length > 0) {
                            const messages = status.messages.slice(-10).map(msg => `<p><i class="fas fa-info-circle me-2"></i>${msg}</p>`).join('');
                            statusDiv.innerHTML = messages;
                        }
                    } else if (status.status === 'completed') {
                        progressBar.style.width = '100%';
                        progressBar.textContent = '100%';
                        statusDiv.innerHTML = `<p class="text-success"><i class="fas fa-check-circle me-2"></i>${status.message}</p>`;
                        clearInterval(interval);
                    } else if (status.status === 'error') {
                        statusDiv.innerHTML = `<p class="text-danger"><i class="fas fa-exclamation-circle me-2"></i>错误: ${status.message}</p>`;
                        clearInterval(interval);
                    }
                } catch (error) {
                    console.error('获取状态失败:', error);
                    clearInterval(interval);
                }
            }, 2000);
        }

        // 列出文件
        async function listFiles() {
            const folderPath = document.getElementById('managementFolderPath').value;
            
            if (!folderPath) {
                alert('请输入文件夹路径');
                return;
            }

            try {
                const response = await fetch('/api/manage_tags', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'list_files',
                        folder_path: folderPath
                    })
                });

                const result = await response.json();
                const fileListDiv = document.getElementById('fileList');

                if (result.files && result.files.length > 0) {
                    const fileItems = result.files.map(file => `
                        <div class="file-item">
                            <h6><i class="fas fa-file-alt me-2"></i>${file.filename}</h6>
                            <p class="text-muted small mb-0">${file.content}</p>
                        </div>
                    `).join('');
                    fileListDiv.innerHTML = fileItems;
                } else {
                    fileListDiv.innerHTML = '<p class="text-muted text-center">没有找到txt文件</p>';
                }

            } catch (error) {
                console.error('列出文件失败:', error);
                document.getElementById('fileList').innerHTML = '<p class="text-danger">列出文件失败</p>';
            }
        }

        // 处理文件
        async function processFiles() {
            const folderPath = document.getElementById('managementFolderPath').value;
            const searchText = document.getElementById('searchText').value;
            const replaceText = document.getElementById('replaceText').value;
            const addTrigger = document.getElementById('addTrigger').checked;
            const triggerWord = document.getElementById('triggerWord').value;

            if (!folderPath) {
                alert('请输入文件夹路径');
                return;
            }

            try {
                const response = await fetch('/api/manage_tags', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'process_files',
                        folder_path: folderPath,
                        search_text: searchText,
                        replace_text: replaceText,
                        add_trigger: addTrigger,
                        trigger_word: triggerWord
                    })
                });

                const result = await response.json();
                const statusDiv = document.getElementById('managementStatus');

                if (result.message) {
                    statusDiv.innerHTML = `<p class="text-success"><i class="fas fa-check-circle me-2"></i>${result.message}</p>`;
                    // 刷新文件列表
                    listFiles();
                } else if (result.error) {
                    statusDiv.innerHTML = `<p class="text-danger"><i class="fas fa-exclamation-circle me-2"></i>错误: ${result.error}</p>`;
                }

            } catch (error) {
                console.error('处理文件失败:', error);
                document.getElementById('managementStatus').innerHTML = '<p class="text-danger">处理文件失败</p>';
            }
        }

        // 转换编码
        async function convertEncoding() {
            const folderPath = document.getElementById('managementFolderPath').value;

            if (!folderPath) {
                alert('请输入文件夹路径');
                return;
            }

            try {
                const response = await fetch('/api/manage_tags', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'convert_encoding',
                        folder_path: folderPath
                    })
                });

                const result = await response.json();
                const statusDiv = document.getElementById('managementStatus');

                if (result.message) {
                    statusDiv.innerHTML = `<p class="text-success"><i class="fas fa-check-circle me-2"></i>${result.message}</p>`;
                } else if (result.error) {
                    statusDiv.innerHTML = `<p class="text-danger"><i class="fas fa-exclamation-circle me-2"></i>错误: ${result.error}</p>`;
                }

            } catch (error) {
                console.error('转换编码失败:', error);
                document.getElementById('managementStatus').innerHTML = '<p class="text-danger">转换编码失败</p>';
            }
        }

        // Custom template management functions
        let currentEditingTemplateId = null;

        // 加载自定义模板列表
        async function loadCustomTemplates() {
            try {
                const response = await fetch('/api/custom_templates');
                const data = await response.json();
                
                const templateList = document.getElementById('templateList');
                
                if (data.templates && data.templates.length > 0) {
                    const templateItems = data.templates.map(template => `
                        <div class="file-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6><i class="fas fa-file-alt me-2"></i>${template.name}</h6>
                                    <p class="text-muted small mb-2">${template.description || '无描述'}</p>
                                    <p class="text-muted small mb-0">${template.prompt.substring(0, 100)}${template.prompt.length > 100 ? '...' : ''}</p>
                                </div>
                                <div class="btn-group-vertical btn-group-sm ms-2">
                                    <button class="btn btn-outline-primary btn-sm" onclick="editTemplate('${template.id}')">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-outline-danger btn-sm" onclick="deleteTemplate('${template.id}')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `).join('');
                    templateList.innerHTML = templateItems;
                } else {
                    templateList.innerHTML = '<p class="text-muted text-center">暂无自定义模板</p>';
                }
            } catch (error) {
                console.error('加载自定义模板失败:', error);
                document.getElementById('templateList').innerHTML = '<p class="text-danger">加载模板失败</p>';
            }
        }

        // 加载自定义模板到下拉选择框
        async function loadCustomTemplatesIntoSelects() {
            try {
                const response = await fetch('/api/custom_templates');
                const data = await response.json();
                
                const singleSelect = document.getElementById('singleAnnotationType');
                const batchSelect = document.getElementById('annotationType');
                
                // 清除现有的自定义模板选项
                Array.from(singleSelect.options).forEach(option => {
                    if (option.value.startsWith('custom_')) {
                        option.remove();
                    }
                });
                Array.from(batchSelect.options).forEach(option => {
                    if (option.value.startsWith('custom_')) {
                        option.remove();
                    }
                });
                
                // 添加自定义模板选项
                if (data.templates && data.templates.length > 0) {
                    data.templates.forEach(template => {
                        const singleOption = new Option(template.name, `custom_${template.id}`);
                        const batchOption = new Option(template.name, `custom_${template.id}`);
                        singleSelect.add(singleOption);
                        batchSelect.add(batchOption);
                    });
                }
            } catch (error) {
                console.error('加载自定义模板到选择框失败:', error);
            }
        }

        // 保存模板
        async function saveTemplate() {
            const name = document.getElementById('templateName').value.trim();
            const description = document.getElementById('templateDescription').value.trim();
            const prompt = document.getElementById('templatePrompt').value.trim();
            
            if (!name || !prompt) {
                alert('模板名称和提示词内容不能为空');
                return;
            }
            
            try {
                let response;
                if (currentEditingTemplateId) {
                    // 更新现有模板
                    response = await fetch(`/api/custom_templates/${currentEditingTemplateId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            name: name,
                            description: description,
                            prompt: prompt
                        })
                    });
                } else {
                    // 创建新模板
                    response = await fetch('/api/custom_templates', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            name: name,
                            description: description,
                            prompt: prompt
                        })
                    });
                }
                
                const result = await response.json();
                
                if (result.success || response.ok) {
                    document.getElementById('templateStatus').innerHTML = `<p class="text-success"><i class="fas fa-check-circle me-2"></i>${currentEditingTemplateId ? '模板更新成功' : '模板创建成功'}</p>`;
                    clearTemplateForm();
                    loadCustomTemplates();
                    loadCustomTemplatesIntoSelects();
                } else {
                    document.getElementById('templateStatus').innerHTML = `<p class="text-danger"><i class="fas fa-exclamation-circle me-2"></i>错误: ${result.error}</p>`;
                }
            } catch (error) {
                console.error('保存模板失败:', error);
                document.getElementById('templateStatus').innerHTML = '<p class="text-danger">保存模板失败</p>';
            }
        }

        // 编辑模板
        async function editTemplate(templateId) {
            try {
                const response = await fetch('/api/custom_templates');
                const data = await response.json();
                
                const template = data.templates.find(t => t.id === templateId);
                if (template) {
                    document.getElementById('templateName').value = template.name;
                    document.getElementById('templateDescription').value = template.description || '';
                    document.getElementById('templatePrompt').value = template.prompt;
                    currentEditingTemplateId = templateId;
                    
                    // 更新按钮文本
                    const saveBtn = document.querySelector('button[onclick="saveTemplate()"]');
                    saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>更新模板';
                }
            } catch (error) {
                console.error('加载模板编辑失败:', error);
            }
        }

        // 删除模板
        async function deleteTemplate(templateId) {
            if (!confirm('确定要删除这个模板吗？此操作不可撤销。')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/custom_templates/${templateId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success || response.ok) {
                    document.getElementById('templateStatus').innerHTML = '<p class="text-success"><i class="fas fa-check-circle me-2"></i>模板删除成功</p>';
                    loadCustomTemplates();
                    loadCustomTemplatesIntoSelects();
                } else {
                    document.getElementById('templateStatus').innerHTML = `<p class="text-danger"><i class="fas fa-exclamation-circle me-2"></i>错误: ${result.error}</p>`;
                }
            } catch (error) {
                console.error('删除模板失败:', error);
                document.getElementById('templateStatus').innerHTML = '<p class="text-danger">删除模板失败</p>';
            }
        }

        // 清空模板表单
        function clearTemplateForm() {
            document.getElementById('templateName').value = '';
            document.getElementById('templateDescription').value = '';
            document.getElementById('templatePrompt').value = '';
            currentEditingTemplateId = null;
            
            // 恢复按钮文本
            const saveBtn = document.querySelector('button[onclick="saveTemplate()"]');
            saveBtn.innerHTML = '<i class="fas fa-save me-2"></i>保存模板';
        }

        // 初始化时隐藏分析类型（默认显示自然语言推理）
        toggleAnalysisTypes();
    </script>
</body>
</html>
